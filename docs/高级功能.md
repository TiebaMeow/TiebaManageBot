# 贴吧管理 bot 高级功能使用手册

version: 2.1.0+20260114

[TOC]

---

## 简介

本手册介绍 `TiebaManageBot` 高级功能的部署和使用方法。

## 部署与配置高级功能

### 前置信息

如果你是用户而非部署者，可以直接阅读[后续章节](#开始使用)。

在部署和使用高级功能前，你需要了解一些高级功能的实现细节，特别是支撑高级功能的两个服务：[TiebaScraper](https://github.com/TiebaMeow/TiebaScraper)、[TiebaContentReviewer](https://github.com/TiebaMeow/TiebaContentReviewer) 和两个基础设施：PostgreSQL、Redis。

#### TiebaScraper

[TiebaScraper](https://github.com/TiebaMeow/TiebaScraper) 是一个专门用于抓取贴吧内容的爬虫服务。它负责从贴吧获取帖子、回复等数据，并将这些数据存储到 PostgreSQL 数据库中。这些数据会被 `TiebaManageBot` 用于各种高级功能。

同时，`TiebaScraper` 还会将抓取到的内容通过 Redis 推送到 `TiebaContentReviewer` 进行内容审查。

#### TiebaContentReviewer

[TiebaContentReviewer](https://github.com/TiebaMeow/TiebaContentReviewer) 是一个内容审查服务。它负责接收来自 `TiebaScraper` 的内容数据，并根据 `TiebaManageBot` 端设定的规则对内容进行审查。审查结果将通过 Redis 推送到 `TiebaManageBot` 进行相应的处理。

#### PostgreSQL

PostgreSQL 是一个关系型数据库管理系统，用于存储 `TiebaScraper` 抓取的贴吧内容数据。注意，如需启用高级功能，`TiebaManageBot` 将不再支持使用 SQLite 作为数据库，bot 的基础数据与审查规则也都需要存储在 PostgreSQL 中。

#### Redis

Redis 是一个内存数据结构存储系统，用于在 `TiebaScraper`、`TiebaContentReviewer` 和 `TiebaManageBot` 之间传递实时数据，如内容审查请求和结果。

### 部署相关服务

要启用 `TiebaManageBot` 的高级功能，你需要部署并配置上述提到的服务。推荐使用 Docker Compose 进行部署，参考 `docker-compose.yml` [示例文件](../docker-compose-all.yml)。

在当前目录下创建上述 `docker-compose.yml` 文件后，请为 `TiebaScraper` 创建一个名为 `config.docker.toml` 的配置文件，内容请参考 [config.docker.example.toml](https://github.com/TiebaMeow/TiebaScraper/blob/main/config.docker.example.toml)。

之后便可以运行以下命令一键启动包括 `TiebaManageBot` 在内的所有服务：

```shell
docker compose up -d
```

注意示例 `docker-compose.yml` 文件中不包含 `NapCat` 服务，请确保你已经单独部署并配置好 `NapCat`，也可以将其编排到 `docker-compose.yml` 文件中。

你也可以选择单独部署 `TiebaScraper`, `TiebaContentReviewer`, PostgreSQL 和 Redis，具体部署方法请参考各自的文档。

## 开始使用

### 指令列表

#### 高级查询

##### 查发言s

- 说明

通过数据库查询指定用户在指定范围贴吧的发言。不指定贴吧时默认查询所有发言。

所查询的贴吧需要在 `TiebaScraper` 的抓取范围内。

- 格式

```shell
/查发言s [贴吧ID] [贴吧1] [贴吧2] ...
```

- 参数

| 参数名  | 类型             | 是否必须 | 描述                         |
| ------- | ---------------- | -------- | ---------------------------- |
| 贴吧 ID | 数字或分享字符串 | 是       | 单个贴吧 ID                  |
| 贴吧    | 字符串           | 否       | 以空格分隔的一个或多个贴吧名 |

- 权限等级

`user`

- 示例

```shell
/查发言s @XXX@给你分享了贴吧号#1234567890#整段复制后打开贴吧即可找到Ta 明日方舟吧 明日方舟终末地吧
/查发言s 1234567890
```

##### 发言统计

- 说明

通过数据库统计指定用户的发言数量。

- 格式

```shell
/发言统计 [贴吧ID]
```

- 参数

| 参数名  | 类型             | 是否必须 | 描述        |
| ------- | ---------------- | -------- | ----------- |
| 贴吧 ID | 数字或分享字符串 | 是       | 单个贴吧 ID |

- 权限等级

`user`

- 示例

```shell
/发言统计 @XXX@给你分享了贴吧号#1234567890#整段复制后打开贴吧即可找到Ta
```

#### 内容审查设置

##### 规则列表

- 说明

列出当前内容审查规则。

- 格式

```shell
/规则列表
```

- 参数

无

- 权限等级

`user`

- 示例

```shell
/规则列表
```

##### 添加关键词

- 说明

添加关键词到内容审查规则中。

- 格式

```shell
/添加关键词 [关键词1] [关键词2] [关键词3]...
```

- 参数

| 参数名 | 类型   | 是否必须 | 描述                         |
| ------ | ------ | -------- | ---------------------------- |
| 关键词 | 字符串 | 是       | 以空格分隔的一个或多个关键词 |

- 权限等级

`admin`

- 示例

```shell
/添加关键词 [foo] [bar] [baz]
# 发送相应字母选择关键词1的处理方式
# a 代表直接删除 (foo)
a
# 发送相应大写字母批量设置剩余所有关键词的处理方式
# B 代表删除并在群内推送通知 (bar, baz)
B
# 更多选项见指令提示
```

##### 删除关键词

- 说明

删除内容审查规则中的关键词。

- 格式

```shell
/删除关键词 [关键词1] [关键词2] [关键词3]...
```

- 参数

| 参数名 | 类型   | 是否必须 | 描述                         |
| ------ | ------ | -------- | ---------------------------- |
| 关键词 | 字符串 | 是       | 以空格分隔的一个或多个关键词 |

- 权限等级

`admin`

- 示例

```shell
/删除关键词 [foo] [bar] [baz]
```

##### 添加监控用户

- 说明

添加需要监控发言内容的用户。

- 格式

```shell
/添加监控用户 [贴吧ID1] [贴吧ID2] [贴吧ID3]...
```

- 参数

| 参数名 | 类型   | 是否必须 | 描述                                 |
| ------ | ------ | -------- | ------------------------------------ |
| 用户   | 字符串 | 是       | 以空格分隔的一个或多个贴吧 ID 字符串 |

- 权限等级

`admin`

- 示例

```shell
/添加监控用户 @XXX@给你分享了贴吧号#1234567890#整段复制后打开贴吧即可找到Ta 1234567890
# 处理方式的选择同添加关键词指令
```

##### 删除监控用户

- 说明

删除监控发言内容的用户。

- 格式

```shell
/删除监控用户 [贴吧ID1] [贴吧ID2] [贴吧ID3]...
```

- 参数

| 参数名 | 类型   | 是否必须 | 描述                                 |
| ------ | ------ | -------- | ------------------------------------ |
| 用户   | 字符串 | 是       | 以空格分隔的一个或多个贴吧 ID 字符串 |

- 权限等级

`admin`

- 示例

```shell
/删除监控用户 @XXX@给你分享了贴吧号#1234567890#整段复制后打开贴吧即可找到Ta 1234567890
```

##### 添加监控艾特

- 说明

添加需要监控艾特的用户。当有人在吧内艾特该用户时，将会推送通知到群内。

- 格式

```shell
/添加监控艾特 [贴吧ID1] [贴吧ID2] [贴吧ID3]...
```

- 参数

| 参数名 | 类型 | 是否必须 | 描述 |
| ------ | ------ | -------- | ------------------------------------ |
| 用户 | 字符串 | 是 | 以空格分隔的一个或多个贴吧 ID 字符串 |

- 权限等级

`admin`

- 示例

```shell
/添加监控艾特 @XXX@给你分享了贴吧号#1234567890#整段复制后打开贴吧即可找到Ta 1234567890
# 监控艾特仅支持推送通知
```

##### 删除监控艾特

- 说明

删除监控艾特的用户。

- 格式

```shell
/删除监控艾特 [贴吧ID1] [贴吧ID2] [贴吧ID3]...
```

- 参数

| 参数名 | 类型 | 是否必须 | 描述 |
| ------ | ------ | -------- | ------------------------------------ |
| 用户 | 字符串 | 是 | 以空格分隔的一个或多个贴吧 ID 字符串 |

- 权限等级

`admin`

- 示例

```shell
/删除监控艾特 @XXX@给你分享了贴吧号#1234567890#整段复制后打开贴吧即可找到Ta 1234567890
```
